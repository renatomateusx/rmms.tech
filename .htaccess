#############################################
# RMMS.cloud - .htaccess
# Apache 2.4+ (mod_rewrite, mod_headers, mod_expires, mod_deflate, mod_proxy_http opcionais)
#############################################

# -----------------------------
# Forçar HTTPS + Canonical host
# -----------------------------
RewriteEngine On

# rmms.tech  -> rmms.cloud
RewriteCond %{HTTP_HOST} ^(www\.)?rmms\.tech$ [NC]
RewriteRule ^(.*)$ https://rmms.cloud/$1 [R=301,L]

# www.rmms.cloud -> rmms.cloud
RewriteCond %{HTTP_HOST} ^www\.rmms\.cloud$ [NC]
RewriteRule ^(.*)$ https://rmms.cloud/$1 [R=301,L]

# HTTP -> HTTPS (em rmms.cloud)
RewriteCond %{HTTP_HOST} ^rmms\.cloud$ [NC]
RewriteCond %{HTTPS} !=on
RewriteRule ^(.*)$ https://rmms.cloud/$1 [R=301,L]

# -----------------------------
# Segurança de transporte e headers base
# -----------------------------
<IfModule mod_headers.c>
  # HSTS (ative preload apenas se TUDO serve https, inclusive subdomínios)
  # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

  # Proteções básicas
  # Header always set X-Frame-Options "SAMEORIGIN"
  # Header always set X-Content-Type-Options "nosniff"
  # Header always set X-XSS-Protection "1; mode=block"
  # Header always set Referrer-Policy "strict-origin-when-cross-origin"

  # ---------------------------
  # Content Security Policy ÚNICA
  # Ajuste domínios conforme seu stack
  # ---------------------------
  # Header always set Content-Security-Policy "
  #   default-src 'self' https://rmms.cloud https://www.rmms.cloud;
  #   script-src 'self' 'unsafe-inline' 'unsafe-eval' https://rmms.cloud https://www.rmms.cloud;
  #   style-src 'self' 'unsafe-inline' https://rmms.cloud https://www.rmms.cloud;
  #   img-src 'self' data: https://rmms.cloud https://www.rmms.cloud;
  #   font-src 'self' data: https://rmms.cloud https://www.rmms.cloud;
  #   frame-src 'self' https://rmms.cloud https://www.rmms.cloud;
  #   connect-src 'self' https://rmms.cloud https://www.rmms.cloud;
  #   frame-ancestors 'self' https://rmms.cloud https://www.rmms.cloud;
  #   form-action 'self' https://rmms.cloud https://www.rmms.cloud;
  #   base-uri 'self' https://rmms.cloud https://www.rmms.cloud;
  # "
</IfModule>

# --------------------------------
# CORS apenas para FONTES LOCAIS
# (isso NÃO habilita CORS de terceiros!)
# --------------------------------
<IfModule mod_headers.c>
  <FilesMatch "\.(?:woff2?|ttf|otf|eot)$">
    Header always set Access-Control-Allow-Origin "https://rmms.cloud"
    Header always set Access-Control-Allow-Methods "GET, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type"
    # Não usar Allow-Credentials com wildcard; aqui origem é explícita.
  </FilesMatch>
</IfModule>

# --------------------------------------------------
# BLOCO OPCIONAL: Proxy de assets Zoho pelo seu domínio
# ÚTIL quando não dá para auto-hospedar (licença!)
# --------------------------------------------------
# Requer mod_proxy e mod_proxy_http habilitados no servidor.
# Se sua hospedagem NÃO permitir, mantenha comentado.
#
# Como usar:
# 1) Descomente as 4 linhas abaixo (RewriteRule e SetEnvIf).
# 2) Troque as referências no seu HTML/CSS para /vendor/zoho/... (ex.: fonts/LatoLatin-Regular.woff2)
# 3) Os headers CORS abaixo serão aplicados SOMENTE nesse caminho.
#
#RewriteRule ^vendor/zoho/(.*)$ https://js.zohostatic.com/support/fbw_v20/$1 [P,QSA,L]
#SetEnvIf Request_URI "^/vendor/zoho/" ZOHO_PROXY=1

# Headers CORS só quando for o proxy (condicionados pela env ZOHO_PROXY)
#<IfModule mod_headers.c>
#  Header always set Access-Control-Allow-Origin "https://rmms.cloud" env=ZOHO_PROXY
#  Header always set Access-Control-Allow-Methods "GET, OPTIONS" env=ZOHO_PROXY
#  Header always set Access-Control-Allow-Headers "Content-Type" env=ZOHO_PROXY
#</IfModule>

# --------------------------------
# Proteção a arquivos sensíveis
# --------------------------------
<FilesMatch "\.(?:htaccess|htpasswd|ini|log|sh|sql|conf)$">
  Require all denied
</FilesMatch>

# -----------------------------
# Desabilitar listagem de dir
# -----------------------------
Options -Indexes

# -----------------------------
# Cache (Expires) e MIME types
# -----------------------------
# <IfModule mod_expires.c>
#   ExpiresActive On

#   # Imagens
#   ExpiresByType image/jpg  "access plus 1 month"
#   ExpiresByType image/jpeg "access plus 1 month"
#   ExpiresByType image/gif  "access plus 1 month"
#   ExpiresByType image/png  "access plus 1 month"
#   ExpiresByType image/webp "access plus 1 month"
#   ExpiresByType image/svg+xml "access plus 1 month"

#   # CSS e JS
#   ExpiresByType text/css "access plus 1 month"
#   ExpiresByType application/javascript "access plus 1 month"
#   ExpiresByType text/javascript "access plus 1 month"

#   # HTML
#   ExpiresByType text/html "access plus 1 hour"

#   # Fontes
#   ExpiresByType application/font-woff "access plus 1 year"
#   ExpiresByType application/font-woff2 "access plus 1 year"
#   ExpiresByType font/woff "access plus 1 year"
#   ExpiresByType font/woff2 "access plus 1 year"
#   ExpiresByType application/x-font-ttf "access plus 1 year"
#   ExpiresByType application/x-font-eot "access plus 1 year"
#   ExpiresByType font/ttf "access plus 1 year"
#   ExpiresByType font/eot "access plus 1 year"
# </IfModule>

# <IfModule mod_headers.c>
#   <FilesMatch "\.(?:css|js|png|jpg|jpeg|gif|ico|svg|webp)$">
#     Header set Cache-Control "max-age=31536000, public"
#   </FilesMatch>
#   <FilesMatch "\.(?:html|htm)$">
#     Header set Cache-Control "max-age=3600, public"
#   </FilesMatch>
# </IfModule>

# -----------------------------
# Compressão GZIP
# -----------------------------
# <IfModule mod_deflate.c>
#   AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css
#   AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
#   AddOutputFilterByType DEFLATE application/javascript application/x-javascript
#   AddOutputFilterByType DEFLATE application/font-woff application/font-woff2
#   AddOutputFilterByType DEFLATE font/woff font/woff2 application/x-font-ttf application/x-font-eot
# </IfModule>

# -----------------------------
# SPA fallback (index.html)
# -----------------------------
# Páginas de erro (ajuste se preferir páginas dedicadas)
ErrorDocument 404 /index.html
ErrorDocument 500 /index.html

# Reescrita SPA: se não é arquivo/dir físico, envia index.html
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ /index.html [L]

# -----------------------------
# MIME Types extras
# -----------------------------
<IfModule mod_mime.c>
  AddType text/css .css
  AddType application/javascript .js
  AddType image/svg+xml .svg
  AddType image/webp .webp
  AddType font/woff .woff
  AddType font/woff2 .woff2
  AddType application/vnd.ms-fontobject .eot
  AddType application/x-font-ttf .ttf
  AddType font/ttf .ttf
  AddType font/eot .eot
</IfModule>
